

<template>
  <div class="productor">
    <div class="recolectar">
      <button
        class="boton-recolectar"
        :disabled="!listoRecolectar"
        @click="recolectar"
      >
        <img alt="" class="" :src="`src/assets/${imagen}`" />
      </button>

      <p v-if="animarRecolectar" class="recolectado">+ {{ produccion }}</p>
    </div>


    <div class="centro">
      <div class="centro-fondo"> </div> 
      <div class="centro-datos">
        <div class="contenedor_nombre">
          <p class="nombre">{{ nombre }}</p>
          <span class="lvl">Lvl: {{ nivel }}</span>
        </div>

         <!-- <div class="contenedor_nombre">
          <p class="produccion">Genera: {{ produccion }} ðŸ’°</p>
          <p v-if="autoRecolectar" class="lvl">Auto recolecciÃ³n on</p>
        </div>  -->

        <div class="barra">
          <div v-if="listoRecolectar" class="barra-datos">
            <span>listo para recolectar</span>
          </div>
          <div v-else class="barra-datos">
            <span>{{ tiempoFalta }}</span>
          </div>

          <div
            class="barra-interna"
            :style="{ width: porcentaje * 100 + '%' }"
          ></div>
        </div>
        <!--fin barra -->

        <button class="boton-mejorar" @click="mejorar" :disabled="disabled">
          MejorarðŸ’° {{ coste }}
        </button>

      </div>
      <!--fin centrodatos -->
    </div>
    <!--fin centro -->
  </div> <!--fin productor -->
</template>
  <!-- {{ tiempoActual }} / {{ tiempo }} -->
  <!-- {{ Math.round(porcentaje * 100) }} % -->

<script setup>
import { ref, computed, toRefs, onMounted, watch } from "vue";
import { useRecursosStore } from "@/store/recursos";

import { storeToRefs } from "pinia";
import { useProductoresStore } from "@/store/productores";

const productoresStore = useProductoresStore();
const { productores } = storeToRefs(productoresStore);

const recursosStore = useRecursosStore();

const props = defineProps({
  nombre: {
    type: String,
    default: "Gnomos",
  },
  imagen: {
    type: String,
    default: "logo.svg",
  },
  nivel: {
    type: Number,
    default: 1,
  },
  produccionInicial: {
    type: Number,
    default: 5,
  },
  costeInicial: {
    type: Number,
    default: 50,
  },
  tiempo: {
    type: Number,
    default: 1,
  },
  autoRecolectar: {
    type: Boolean,
    default: false,
  },
});

const MULTIPLICADOR = 1.17;

const { produccionInicial, costeInicial, autoRecolectar } = toRefs(props);
const nivel = ref(props.nivel);
const tiempoActual = ref(0);
const lastUpdate = ref(Date.now());
const listoRecolectar = ref(false);
const animarRecolectar = ref(false);

//** computed */
const produccion = computed(() => {
  return produccionInicial.value * nivel.value;
});

const coste = computed(() => {
  return Math.trunc(costeInicial.value * Math.pow(nivel.value, MULTIPLICADOR));
});

const disabled = computed(() => {
  let disabled = recursosStore.recursos > coste.value ? false : true;
  return disabled;
});

const porcentaje = computed(() => {
  return tiempoActual.value / props.tiempo;
});

const tiempoFalta = computed(() => {
  let segundos = Math.round(props.tiempo - tiempoActual.value);

  var date = new Date(null);
  date.setSeconds(segundos); // specify value for SECONDS here
  var result = date.toISOString().substr(11, 8);
  return result;
});

const wait = (timeToDelay) =>
  new Promise((resolve) => setTimeout(resolve, timeToDelay));

const mejorar = () => {
  recursosStore.recursos -= coste.value;
  nivel.value++;
};

const recolectar = () => {
  recursosStore.recursos += produccion.value;
  lastUpdate.value = Date.now();
  tiempoActual.value = 0;
  listoRecolectar.value = false;

  animarRecolect();
};

const animarRecolect = async () => {
  animarRecolectar.value = true;
  await wait(1000);
  animarRecolectar.value = false;
};

const updateTiempo = async () => {
  while (true) {
    await wait(100);
    if (listoRecolectar.value) continue;
    const elapsed = Date.now() - lastUpdate.value;
    tiempoActual.value = elapsed / 1000;
    if (elapsed > props.tiempo * 1000) {
      lastUpdate.value = Date.now();
      listoRecolectar.value = true;
      tiempoActual.value = props.tiempo;

      if (autoRecolectar.value) {
        recolectar();
      }
    }
  }
};

onMounted(() => {
  updateTiempo();
});

watch(props.tiempo, (val) => {
  lastUpdate.value = Date.now();
  tiempoActual.value = 0;
});

watch(autoRecolectar, (val) => {
  if (listoRecolectar.value) {
    recolectar();
  }
});
</script>


<style lang="scss"  >
@import "@/scss/_variables.scss";

button,
.productor {
  font-size: 14px;
}
.productor {
  min-width: 350px;
  display: flex;
  padding: 5px;
  font-weight: bolder;

  .recolectar {
    display: flex;
    position: relative;

    .boton-recolectar {
      padding: -5px;
      height: 100%;
      border: 2px solid orange;
      border-radius:  50% ;
      animation: infinite resplandorAnimation 1s;
      background-color: rgb(244, 255, 214);


      img {
        --width: 60px;
      }
    }

    .boton-recolectar:disabled {
      border: 2px solid transparent;
      animation: none;
    }

    .recolectado {
      position: absolute;
      width: max-content;
      top: 50%;
      right: 50%;
      color: rgb(132, 255, 132);
      animation: 1 generarDinero 1s;
    }
  }

  .centro{
    width: 100%;
    display: flex;
    --align-items: flex-end;
    position: relative;
  }

  .centro-fondo{
    align-self: center;
    flex: 1;
    background-color: rgb(244, 255, 214);
    position: absolute;
    width: calc(100% + 30px);
    height: 75%;
    margin-left: -30px;
    border-radius: 0 10px 10px 0;
    z-index: -1;
  }

  .centro-datos{
    flex: 1 0;
    height: 100%;

    

    margin-left: -30px;
    padding: 25px 10px 0px 0;
    padding-left: 37px;
    border-radius: 0 10px 10px 0;

  
    display: flex;
    flex-direction: column;
    justify-content: center;
    --background-color: rgb(244, 255, 214);
    gap: 5px;
   
  

    .contenedor_nombre {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .nombre {
      font-size: 1.1rem;
      color: black;
    }
    .lvl {
      color: grey;
    }

    .produccion {
      margin-bottom: 3px;
    }
    .barra {
      text-align: center;
      border: 2px solid green;
      position: relative;
      height: 1.5rem;
      border-radius: 5px;
      color: rgb(15, 15, 15);

      .barra-interna,
      .barra-datos {
        position: absolute;
        height: 100%;
        width: 100%;
        max-width: 100%;
        top: 0;
        left: 0;
        border-radius: 3px;
      }
      .barra-interna {
        background-color: greenyellow;
      }

      .barra-datos {
        z-index: 1;
        display: flex;
        justify-content: center;
        align-items: center;
      }
    }
  }

  .boton-mejorar {
    background-color: $base-color;
    border-radius: 5px;
  }
}

@keyframes resplandorAnimation {
  0%,
  100% {
    box-shadow: 0px 0px 5px orange;
  }
  50% {
    box-shadow: 0px 0px 0px orangered;
  }
}

@keyframes generarDinero {
  0% {
    top: 50%;
  }
  70% {
    top: 0%;
    color: rgba(132, 255, 132);
  }
  100% {
    top: -20%;
    color: rgba(132, 255, 132, 0);
  }
}
</style>